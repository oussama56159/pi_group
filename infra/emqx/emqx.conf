# ============================================================================
# AeroCommand EMQX Configuration
# Production MQTT Broker for Drone & Robot Fleet Management
# NOTE: Requires TLS certs in ./infra/certs for SSL/WSS listeners.
# ============================================================================

node {
    name = "emqx@127.0.0.1"
    cookie = "aerocommand_emqx_secret_cookie"
    data_dir = "/opt/emqx/data"
}

# ── Listeners ──
listeners.tcp.default {
    bind = "0.0.0.0:1883"
    max_connections = 10000
    proxy_protocol = false
}

listeners.ws.default {
    bind = "0.0.0.0:8083"
    max_connections = 5000
    websocket.mqtt_path = "/mqtt"
}

listeners.ssl.default {
    bind = "0.0.0.0:8883"
    max_connections = 10000
    ssl_options {
        cacertfile = "/opt/emqx/etc/certs/ca.pem"
        certfile   = "/opt/emqx/etc/certs/server.pem"
        keyfile    = "/opt/emqx/etc/certs/server.key"
        verify     = verify_peer
        fail_if_no_peer_cert = false
    }
}

listeners.wss.default {
    bind = "0.0.0.0:8084"
    max_connections = 5000
    websocket.mqtt_path = "/mqtt"
    ssl_options {
        cacertfile = "/opt/emqx/etc/certs/ca.pem"
        certfile   = "/opt/emqx/etc/certs/server.pem"
        keyfile    = "/opt/emqx/etc/certs/server.key"
    }
}

# ── Authentication (PostgreSQL backend) ──
authentication = [
    {
        mechanism = password_based
        backend = built_in_database
        user_id_type = username
    }
]

# ── Authorization (ACL) ──
authorization {
    no_match = deny
    deny_action = disconnect
    sources = [
        {
            type = built_in_database
            enable = true
        }
    ]
}

# ── MQTT Protocol Settings ──
mqtt {
    max_packet_size = 1MB
    max_clientid_len = 256
    max_topic_levels = 10
    max_qos_allowed = 2
    max_topic_alias = 65535
    retain_available = true
    wildcard_subscription = true
    shared_subscription = true
    keepalive_multiplier = 1.5
}

# ── Session / Queue ──
session {
    max_subscriptions = 100
    upgrade_qos = false
    max_inflight = 100
    retry_interval = 30s
    max_awaiting_rel = 100
    await_rel_timeout = 300s
}

# ── Rate Limiting ──
limiter {
    max_conn_rate = "500/s"
    messages_rate = "1000/s"
    bytes_rate = "10MB/s"
}

# ── Dashboard ──
dashboard {
    listeners.http {
        bind = "0.0.0.0:18083"
    }
    default_username = "admin"
    default_password = "aerocommand_emqx_admin"
}

# ── Logging ──
log {
    console {
        enable = true
        level = warning
    }
    file {
        enable = true
        level = info
        path = "/opt/emqx/log/emqx.log"
        rotation_count = 10
        rotation_size = 50MB
    }
}

